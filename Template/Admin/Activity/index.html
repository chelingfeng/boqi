<extend name="Public/__base" />
<block name="body">
        
<div class="page-main" style="left:170px;top:50px;">

    <div class="history-container ng-scope">
        <a class="return-btn" onclick="history.go(-1)">
            <i class="ALiconfont icon-sortleft"></i> 返回 
        </a> 
        <ul class="history-list">
            <li><a href="javascript:void(0)">活动管理</a></li>
            <li>秒杀</li>
        </ul>
    </div>


    <div class="page-tabs" style="top:50px;">

        <ul class="page-tabs-nav">
            <li class="active" onclick="location.href='{:U('index')}'">秒杀</li>
            <li class="" onclick="location.href='{:U('cut')}'">砍价</li>
            <li class="" onclick="location.href='{:U('groupon')}'">拼团</li>
        </ul>

        <form method="post" action="" id="formsubmit">
        <div class="tool-bar ng-scope" style="background:#fff;border-bottom:1px solid #dfe0e0">
            <div class="bar-full">
                <a class="btn btn-addon btn-success ng-scope" id="add"><i class="glyphicon glyphicon-plus"></i>新建秒杀</a>
                <a class="btn btn-addon btn-info ng-scope" id="manage_carousel"><i class="glyphicon glyphicon-plus"></i>轮播管理</a>
            </div>
            <div>
                <select class="form-control type" style="width:160px;" name="status" id="status">
                    <option value="">全部状态</option>
                    <?php foreach (C('activity_status') as $status => $title) { ?>
                    <option value="{$status}" <?php if($status == $_POST['status']) {echo 'selected';}?>>{$title}
                    </option>
                    <?php } ?>
                </select>
            </div>
            <div class="search-bool">
                <div class="input-group ng-pristine ng-valid">
                    <input type="text" class="form-control ng-pristine ng-untouched ng-valid" placeholder="活动名称" name="keyword" value="{$Think.post.keyword}">
                    <span class="input-group-btn">
                        <button type="submit" class="btn btn-default" id="search_btn">
                            <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                        </button>
                    </span>
                </div>
            </div>
        </div>
        </form>

        <ul class="page-tabs-container">
            <li class="fadeIn animated active">
                <div class="table-container" style="top:50px;background:#fff">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>活动名称</th>
                                <th>活动时间</th>
                                <th>活动价</th>
                                <th>原价</th>
                                <th>剩余数量/总数量</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr> 
                        </thead>
                        <tbody>
                            <?php foreach($data as $v){ ?>
                            <tr>
                                <td>{$v.title}</td>
                                <td>{$v.start_time} - {$v.end_time}</td>
                                <td><?=sprintf("%.2f", $v['original_price'] / 100);?></td>
                                <td><?=sprintf("%.2f", $v['price'] / 100);?></td>
                                <td>{$v['rule']['product_remaind']}/{$v['rule']['product_sum']}</td>
                                <td>
                                    <?=C('activity_status')[$v['status']];?>
                                    <?php if ($v['status'] == 'ongoing'){ ?>
                                    <a class="btn btn-danger btn-xs closed" data-id="{$v.id}">关闭</a>
                                    <?php } ?>
                                    <?php if ($v['status'] == 'closed' && strtotime($v['start_time']) < time() && strtotime($v['end_time']) > time()){ ?>
                                    <a class="btn btn-success btn-xs open" data-id="{$v.id}">重新打开</a>
                                    <?php } ?>
                                </td>
                                <td>
                                    <a class="btn btn-success btn-xs" href="{:U('order', array('id' => $v['id']))}">订单数据</a>
                                    <?php if ($v['status'] == 'unstart'){ ?>
                                    <a class="btn btn-info btn-xs edit" data-id="{$v.id}">修改</a>
                                    <?php } ?>
                                    <a class="btn btn-danger btn-xs delete" data-id="{$v.id}">删除</a>
                                </td>
                            </tr> 
                            <?php } ?>
                            <?php if(count($data) == 0){ ?>
                            <tfoot>
                                <tr>
                                    <td colspan="20" class="empty">没有检索到相关数据</td>
                                </tr>
                            </tfoot> 
                            <?php } ?>
                        </tbody>
                    </table>
                </div>
                {$page}
            </li>
        </ul>
    </div>
</div>

<div class="info-card fadeIn animated ng-scope" id="add_card">
    <div class="info-card-wrapper">
        <div class="info-card-dialog">
            <div class="info-card-content">
                <div class="panel panel-info">
                    <div class="panel-heading"> 新建秒杀
                        <a class="info-card-close"><i class="ALiconfont icon-close"></i></a>
                    </div>
                    <div class="panel-body">
                        <div class="form-tabs">
                            <ul class="form-tabs-container">
                                <li class="fadeIn animated active">
                                    <table class="table-bordered bg-white table-form">
                                        <tbody>
                                            <tr>
                                                <td class="require" width="25%">活动名称</td>
                                                <td>
                                                    <input type="text" name="title">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="require">原价</td>
                                                <td>
                                                    <input type="text" name="original_price">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="require">活动价</td>
                                                <td>
                                                    <input type="text" name="price">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="require">商品总数</td>
                                                <td>
                                                    <input type="text" name="product_sum">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="require">标题图</td>
                                                <td>
                                                    <div class="album" style="min-height:0px">
                                                        <ul>
                                                            <li class="album-plus relative">
                                                                <span class="ALiconfont icon-plus3"></span>
                                                                <i class="ALiconfont icon-trash i hide"></i>
                                                                <img src="" name="thumb">
                                                            </li>
                                                        </ul>
                                                    </div>
                                                    建议大小：400px * 400px
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="require">轮播图</td>
                                                <td>
                                                    建议大小：500px * 165px
                                                    <div class="album" style="min-height:0px">
                                                        <ul>
                                                            <li class="album-plus relative">
                                                                <span class="ALiconfont icon-plus3"></span>
                                                                <i class="ALiconfont icon-trash i hide"></i>
                                                                <img src="" name="carousel">
                                                            </li>
                                                            <li class="album-plus relative">
                                                                <span class="ALiconfont icon-plus3"></span>
                                                                <i class="ALiconfont icon-trash i hide"></i>
                                                                <img src="" name="carousel">
                                                            </li>
                                                            <li class="album-plus relative">
                                                                <span class="ALiconfont icon-plus3"></span>
                                                                <i class="ALiconfont icon-trash i hide"></i>
                                                                <img src="" name="carousel">
                                                            </li>
                                                            <li class="album-plus relative">
                                                                <span class="ALiconfont icon-plus3"></span>
                                                                <i class="ALiconfont icon-trash i hide"></i>
                                                                <img src="" name="carousel">
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="require">活动时间</td>
                                                <td>
                                                    <input type="text" name="start_time" class="datetime"> - <input type="text" name="end_time" class="datetime">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="td-btn-box" colspan="2">
                                                    <a class="btn btn-success" id="add_action">确定</a>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="info-card fadeIn animated ng-scope" id="edit_card">
    <div class="info-card-wrapper">
        <div class="info-card-dialog">
            <div class="info-card-content">
                <div class="panel panel-info">
                    <div class="panel-heading"> 修改秒杀
                        <a class="info-card-close"><i class="ALiconfont icon-close"></i></a>
                    </div>
                    <div class="panel-body">
                        <div class="form-tabs">
                            <ul class="form-tabs-container">
                                <li class="fadeIn animated active">
                                    <table class="table-bordered bg-white table-form">
                                        <tbody>
                                            <tr>
                                                <td class="require" width="25%">活动名称</td>
                                                <td>
                                                    <input type="text" name="title">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="require">原价</td>
                                                <td>
                                                    <input type="text" name="original_price">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="require">活动价</td>
                                                <td>
                                                    <input type="text" name="price">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="require">商品总数</td>
                                                <td>
                                                    <input type="text" name="product_sum">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="require">标题图</td>
                                                <td>
                                                    <div class="album" style="min-height:0px">
                                                        <ul>
                                                            <li class="album-plus relative">
                                                                <span class="ALiconfont icon-plus3 hide"></span>
                                                                <i class="ALiconfont icon-trash i hide"></i>
                                                                <img src="" name="thumb">
                                                            </li>
                                                        </ul>
                                                    </div>
                                                    建议大小：400px * 400px
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="require">轮播图</td>
                                                <td>
                                                    建议大小：500px * 165px
                                                    <div class="album" style="min-height:0px">
                                                        <ul>
                                                            <li class="album-plus relative">
                                                                <span class="ALiconfont icon-plus3"></span>
                                                                <i class="ALiconfont icon-trash i hide"></i>
                                                                <img src="" name="carousel">
                                                            </li>
                                                            <li class="album-plus relative">
                                                                <span class="ALiconfont icon-plus3"></span>
                                                                <i class="ALiconfont icon-trash i hide"></i>
                                                                <img src="" name="carousel">
                                                            </li>
                                                            <li class="album-plus relative">
                                                                <span class="ALiconfont icon-plus3"></span>
                                                                <i class="ALiconfont icon-trash i hide"></i>
                                                                <img src="" name="carousel">
                                                            </li>
                                                            <li class="album-plus relative">
                                                                <span class="ALiconfont icon-plus3"></span>
                                                                <i class="ALiconfont icon-trash i hide"></i>
                                                                <img src="" name="carousel">
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="require">活动时间</td>
                                                <td>
                                                    <input type="text" name="start_time" class="datetime"> - <input
                                                        type="text" name="end_time" class="datetime">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="td-btn-box" colspan="2">
                                                    <input type="hidden" name="id" />
                                                    <a class="btn btn-info" id="edit_action">保存</a>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="info-card fadeIn animated ng-scope" id="carousel_card">
    <div class="info-card-wrapper">
        <div class="info-card-dialog">
            <div class="info-card-content">
                <div class="panel panel-info">
                    <div class="panel-heading"> 轮播管理
                        <a class="info-card-close"><i class="ALiconfont icon-close"></i></a>
                    </div>
                    <div class="panel-body">
                        <div class="form-tabs">
                            <ul class="form-tabs-container">
                                <li class="fadeIn animated active">
                                    <table class="table-bordered bg-white table-form">
                                        <tbody>
                                            <tr>
                                                <td class="require">轮播图</td>
                                                <td>
                                                    建议大小：600px * 200px
                                                    <div class="album" style="min-height:0px">
                                                        <ul>
                                                            <li class="album-plus relative">
                                                                <span class="ALiconfont icon-plus3"></span>
                                                                <i class="ALiconfont icon-trash i hide"></i>
                                                                <img src="" name="img">
                                                            </li>
                                                            <li class="album-plus relative">
                                                                <span class="ALiconfont icon-plus3"></span>
                                                                <i class="ALiconfont icon-trash i hide"></i>
                                                                <img src="" name="img">
                                                            </li>
                                                            <li class="album-plus relative">
                                                                <span class="ALiconfont icon-plus3"></span>
                                                                <i class="ALiconfont icon-trash i hide"></i>
                                                                <img src="" name="img">
                                                            </li>
                                                            <li class="album-plus relative">
                                                                <span class="ALiconfont icon-plus3"></span>
                                                                <i class="ALiconfont icon-trash i hide"></i>
                                                                <img src="" name="img">
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="td-btn-box" colspan="2">
                                                    <a class="btn btn-info" id="carousel_action">保存</a>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(function(){

        $("#carousel_action").click(function(){
            var data = [];
            var i = 0;
            $("#carousel_card [name='img']").each(function () {
                if ($(this).attr('src') != '') {
                    data[i] = {
                        "img": $(this).attr('src')
                    };
                    i++;
                }
            });
            $(".loading").show();
            $.ajax({
                url: "{:U('saveCarousel')}",
                type: 'POST',
                data: { type: 'seckill', data: data },
                success: function (data) {
                    if (data.code == 0) {
                        swal({ title: "提示", text: "保存成功", type: "success", timer: 1500, }, function () {
                            window.location.reload();
                        });
                    } else {
                        swal("提示", data.msg, "warning");
                    }
                    $(".loading").hide();
                }
            })
        });

        $("#manage_carousel").click(function(){
            $(".loading").show();
            $.ajax({
                url: "{:U('getCarousel')}",
                type: 'POST',
                data: { type: 'seckill'},
                success: function (data) {
                    if (data.code == 0) {
                        $("#carousel_card [name='img']").attr('src', '');
                        $("#carousel_card .icon-plus3").removeClass('hide');
                        data.data.forEach(function(item, index){
                            $("#carousel_card [name='img']:eq("+index+")").attr('src', item.img);
                            $("#carousel_card .icon-plus3:eq("+index+")").addClass('hide');
                        });
                        $("#carousel_card").addClass('show')
                    } else {
                        swal("提示", data.msg, "warning");
                    }
                    $(".loading").hide();
                }
            })
        });

        $("#add").click(function () {
            $("#add_card").addClass('show');
            return false;
        });

        $("#status").change(function () {
            $("#formsubmit").submit();
        });

        $(".closed").click(function () {
            var id = $(this).attr('data-id');
            swal({
                title: "提示",
                text: "确定要关闭活动吗？",
                type: "warning",
                showCancelButton: true,
                closeOnConfirm: false,
                cancelButtonText: '取消',
                confirmButtonText: '确定'
            }, function () {
                $(".loading").show();
                $.ajax({
                    url: "{:U('editActivityStatus')}",
                    type: 'POST',
                    data: { id: id, status: 'closed' },
                    success: function (data) {
                        if (data.code == 0) {
                            swal({ title: "提示", text: "操作成功", type: "success", timer: 1500, }, function () {
                                window.location.reload();
                            });
                        } else {
                            swal("提示", data.msg, "warning");
                        }
                        $(".loading").hide();
                    }
                })
            });
        });

        $(".open").click(function () {
            var id = $(this).attr('data-id');
            swal({
                title: "提示",
                text: "确定要重新打开活动吗？",
                type: "warning",
                showCancelButton: true,
                closeOnConfirm: false,
                cancelButtonText: '取消',
                confirmButtonText: '确定'
            }, function () {
                $(".loading").show();
                $.ajax({
                    url: "{:U('editActivityStatus')}",
                    type: 'POST',
                    data: { id: id, status: 'ongoing' },
                    success: function (data) {
                        if (data.code == 0) {
                            swal({ title: "提示", text: "操作成功", type: "success", timer: 1500, }, function () {
                                window.location.reload();
                            });
                        } else {
                            swal("提示", data.msg, "warning");
                        }
                        $(".loading").hide();
                    }
                })
            });
        });

        //修改
        $(".edit").click(function () {
            var id = $(this).attr('data-id');
            $(".loading").show();
            $.ajax({
                url: "{:U(find)}",
                type: 'POST',
                data: { id: id },
                success: function (data) {
                    if (data.code == 0) {
                        $("#edit_card [name='title']").val(data.data.title);
                        $("#edit_card [name='original_price']").val(data.data.original_price / 100);
                        $("#edit_card [name='price']").val(data.data.price / 100);
                        $("#edit_card [name='product_sum']").val(data.data.rule.product_sum);
                        $("#edit_card [name='id']").val(data.data.id);
                        $("#edit_card [name='start_time']").val(data.data.start_time);
                        $("#edit_card [name='end_time']").val(data.data.end_time);
                        $("#edit_card [name='thumb']").attr('src', data.data.thumb);
                        $("#edit_card [name='carousel']").attr('src', '');
                        $("#edit_card [name='carousel']").parent('li').find('.icon-plus3').removeClass('hide');
                        data.data.carousel.forEach(function (item, index) {
                            $("#edit_card [name='carousel']:eq(" + index + ")").attr('src', item);
                            $("#edit_card [name='carousel']:eq(" + index + ")").parent('li').find('.icon-plus3').addClass('hide');
                        })
                        $("#edit_card").addClass('show');
                    } else {
                        swal("提示", data.msg, "warning");
                    }
                    $(".loading").hide();
                }
            })
        });

        $(".delete").click(function () {
            var id = $(this).attr('data-id');
            swal({
                title: "提示",
                text: "确定要删除这条记录吗？",
                type: "warning",
                showCancelButton: true,
                closeOnConfirm: false,
                cancelButtonText: '取消',
                confirmButtonText: '确定'
            }, function () {
                $(".loading").show();
                $.ajax({
                    url: "{:U('delete')}",
                    type: 'POST',
                    data: { id: id },
                    success: function (data) {
                        if (data.code == 0) {
                            swal({ title: "提示", text: "删除成功", type: "success", timer: 1500, }, function () {
                                window.location.reload();
                            });
                        } else {
                            swal("提示", data.msg, "warning");
                        }
                        $(".loading").hide();
                    }
                })
            });
        });


        //点击页码
        $(".pagination a").click(function () {
            if (typeof ($(this).attr('href')) != 'undefined') {
                $('#formsubmit').attr('action', $(this).attr('href')).submit();
            }
            return false;
        });

        $('.datetime').datetimepicker({
            format: "yyyy-mm-dd hh:ii",
            language: 'zh-CN',
            autoclose: true,
            todayBtn: true,
            pickerPosition: 'top-left'
        });

        //点击确定
        $("#add_action").click(function () {
            var data = {
                title: $("#add_card [name='title']").val(),
                original_price: $("#add_card [name='original_price']").val(),
                price: $("#add_card [name='price']").val(),
                product_sum: $("#add_card [name='product_sum']").val(),
                start_time: $("#add_card [name='start_time']").val(),
                end_time: $("#add_card [name='end_time']").val(),
                carousel: [],
                thumb: $("#add_card [name='thumb']").attr('src'),
            };
            if (data.title == '') {
                swal({ title: "提示", text: "活动名称不能为空", type: "warning" }, function () {
                    $("#add_card [name='title']").focus();
                });
                return false;
            }
            if (data.original_price == '') {
                swal({ title: "提示", text: "原价不能为空", type: "warning" }, function () {
                    $("#add_card [name='original_price']").focus();
                });
                return false;
            }
            if (data.price == '') {
                swal({ title: "提示", text: "活动价不能为空", type: "warning" }, function () {
                    $("#add_card [name='price']").focus();
                });
                return false;
            }
            if (data.product_sum == '') {
                swal({ title: "提示", text: "商品总数不能为空", type: "warning" }, function () {
                    $("#add_card [name='product_sum']").focus();
                });
                return false;
            }
            if (data.thumb == '') {
                swal({ title: "提示", text: "请上传标题图", type: "warning" }, function () {
                    
                });
                return false;
            }
            if (data.start_time == '') {
                swal({ title: "提示", text: "活动开始时间不能为空", type: "warning" }, function () {
                    $("#add_card [name='start_time']").focus();
                });
                return false;
            }
            if (data.end_time == '') {
                swal({ title: "提示", text: "活动结束时间不能为空", type: "warning" }, function () {
                    $("#add_card [name='end_time']").focus();
                });
                return false;
            }
            var i = 0;
            $("#add_card [name='carousel']").each(function () {
                if ($(this).attr('src') != '') {
                    data.carousel[i] = $(this).attr('src');
                    i++;
                }
            });
            if (data.carousel.length == 0) {
                 swal({ title: "提示", text: "请至少上传一张轮播图", type: "warning" }, function () {

                });
                return false;
            }
            data.carousel = JSON.stringify(data.carousel);

            $(".loading").show();
            $.ajax({
                type: 'POST',
                url: "{:U('addSeckill')}",
                data: data,
                success: function (data) {
                    if (data.code == 0) {
                        swal({ title: "提示", text: "添加成功", type: "success", timer: 1500, }, function () {
                            window.location.reload();
                        });
                    } else {
                        swal("提示", data.msg, "warning");
                    }
                    $(".loading").hide();
                }
            });
        });

          //点击确定
        $("#edit_action").click(function () {
            var data = {
                id: $("#edit_card [name='id']").val(),
                title: $("#edit_card [name='title']").val(),
                original_price: $("#edit_card [name='original_price']").val(),
                price: $("#edit_card [name='price']").val(),
                product_sum: $("#edit_card [name='product_sum']").val(),
                start_time: $("#edit_card [name='start_time']").val(),
                end_time: $("#edit_card [name='end_time']").val(),
                carousel: [],
                thumb: $("#edit_card [name='thumb']").attr('src'),
            };
            if (data.title == '') {
                swal({ title: "提示", text: "活动名称不能为空", type: "warning" }, function () {
                    $("#edit_card [name='title']").focus();
                });
                return false;
            }
            if (data.original_price == '') {
                swal({ title: "提示", text: "原价不能为空", type: "warning" }, function () {
                    $("#edit_card [name='original_price']").focus();
                });
                return false;
            }
            if (data.price == '') {
                swal({ title: "提示", text: "活动价不能为空", type: "warning" }, function () {
                    $("#edit_card [name='price']").focus();
                });
                return false;
            }
            if (data.product_sum == '') {
                swal({ title: "提示", text: "商品总数不能为空", type: "warning" }, function () {
                    $("#edit_card [name='product_sum']").focus();
                });
                return false;
            }
            if (data.thumb == '') {
                swal({ title: "提示", text: "请上传标题图", type: "warning" }, function () {

                });
                return false;
            }
            if (data.start_time == '') {
                swal({ title: "提示", text: "活动开始时间不能为空", type: "warning" }, function () {
                    $("#edit_card [name='start_time']").focus();
                });
                return false;
            }
            if (data.end_time == '') {
                swal({ title: "提示", text: "活动结束时间不能为空", type: "warning" }, function () {
                    $("#edit_card [name='end_time']").focus();
                });
                return false;
            }
            var i = 0;
            $("#edit_card [name='carousel']").each(function () {
                if ($(this).attr('src') != '') {
                    data.carousel[i] = $(this).attr('src');
                    i++;
                }
            });
            if (data.carousel.length == 0) {
                swal({ title: "提示", text: "请至少上传一张轮播图", type: "warning" }, function () {

                });
                return false;
            }
            data.carousel = JSON.stringify(data.carousel);

            $(".loading").show();
            $.ajax({
                type: 'POST',
                url: "{:U('editSeckill')}",
                data: data,
                success: function (data) {
                    if (data.code == 0) {
                        swal({ title: "提示", text: "添加成功", type: "success", timer: 1500, }, function () {
                            window.location.reload();
                        });
                    } else {
                        swal("提示", data.msg, "warning");
                    }
                    $(".loading").hide();
                }
            });
        });
        
    });
</script>
</block>
